<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>O que tem pra hoje?</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-aFq/bzH65dt+w6FI2ooMVUpc+21e0SRygnTpmBvdBgSdnuTN7QbdgL+OapgHtvPp" crossorigin="anonymous">
    <link rel="shortcut icon" href="../../../assets/favicon.ico">
</head>
<body>

<!--Menu de navegação-->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">
            <img src="../../../assets/logo.png"" alt="logo" width="150" height="150">
        </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
    
            <li class="d-flex nav-item me-3">
                <a class="nav-link" href="../03-BuscarReceitas/index.html"><h5>Buscar Receitas</h5></a>
            </li>
            <li class="d-flex nav-item me-3">
                <a class="nav-link" href="../06-MinhasReceitas/index.html"><h5>Minhas Receitas</h5></a>
            </li>
            <li class="d-flex nav-item me-3">
                <a class="nav-link" href="../05-MeuPerfil/index.html"><h5>Meu Perfil</h5></a>
            </li>
          </div>
        </div>
      </nav>

<!--Conteúdo Página -->
    <div class="container mt-5">
    <div class="row align-items-center">   
      <div class="col-md-10 mx-auto col-lg-5">
        <form class="p-4 p-md-5 border rounded-3 bg-light">
          <div class="mb-3 mx-auto" style="width: 150px;">
          <a class="navbar-brand" href="#">
            <img src="/frontend/src/assets/logo.png" alt="logo" width="150" height="150">
          </a>
          <h2>Meu Perfil</h2>
        </div>
        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="Nome-cadastrado" placeholder="" autocomplete="off" disabled/>
            <label for="name">Nome</label>
          </div>
          <div class="form-floating mb-3">
            <input type="email" class="form-control" id="inputEmail-cadastrado" placeholder="" disabled/>
            <label for="inputEmail">E-mail</label>
          </div>
          <div class="form-floating mb-5">
            <input type="password" class="form-control" id="show_hide_password" disabled/>
            <label for="inputPassword">Senha</label>
          </div>
          <!-- Botão que irá abrir o modal -->
          <button type="button" class="btn btn-lg btn-success w-100 mb-5" data-toggle="modal" data-target="#meuModal">Editar</button>
          <button type="button" class= "btn btn-lg btn-danger w-100 mb-5" value="Apagar Usuário" onclick="apagaLogin(event)">Apagar Usuário</button>
        </form>     
  <!-- Modal -->
  <div class="modal fade" id="meuModal" tabindex="-1" role="dialog" aria-labelledby="meuModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <!-- Conteúdo do modal-->
        <div class="modal-content">
            <!-- Cabeçalho do modal -->
            <div class="modal-header">
              <h5 class="modal-title" id="meuModalLabel">Olá Chef!</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <!-- Corpo do modal -->
            <div class="modal-body">
                <div class="form-group">
                    <label for="name" class="col-form-label"><strong>E-mail:</strong></label>
                    <input type="text" class="form-control" id="email" size="20" maxlenght="30" placeholder="E-mail" required>
                </div>
                <div class="form-group">
                    <label for="password" class="col-form-label"><strong>Senha:</strong></label>
                    <input type="password" name="password" class="form-control" id="password" size="11"  placeholder="" required>
                </div>
                <div class="full-box" onclick="editaLogin(event)">
                    <input id="btn-submit" type="submit" value="Salvar alterações">
                </div>
            </div>
        </div>
      </div>
    </div>
   </div>
  </div>
</div>



<!--Script --> 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.bundle.min.js" integrity="sha384-qKXV1j0HvMUeCBQ+QVp7JcfGl760yU08IQ+GpUo5hlbpg51QRiuqHAJz8+BrxE/N" crossorigin="anonymous"></script>
</body>
</html>
<script>
  $(document).ready(function () {
      console.log("A tela carregou!")
      getUserInfo(event);
  })
  
  function getUserInfo(event){
      let item = JSON.parse(localStorage.getItem("cache-login-user")).userInfo;
      document.getElementById("Nome-cadastrado").value = item.nome
      document.getElementById("inputEmail-cadastrado").value = item.email
      document.getElementById("phoneNumber-cadastrado").value = item.celular
  }


  async function apagaLogin(event){
      event.preventDefault();

      console.log("Função para apagar o formulário do perfil...")

      let id = JSON.parse(localStorage.getItem("cache-login-user")).id;

      console.log("Chamando a api para apagar o perfil......")

      let baseURL = `https://matchbookapi.herokuapp.com/api/v1/deleta-usuario?idUsuario=${id}`;

      fetch(baseURL, {
          method: 'DELETE',
          headers: {
              'Access-Control-Allow-Origin': '*',
              'Access-Control-Allow-Headers': '*',
              'Content-Type': 'application/json',
              'Access-Control-Allow-Methods': 'DELETE',
              'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
          }
      }).then(res => {
          this.getDelete()
      }).catch(err => {
          console.log("A resposta da API quebrou...")
          console.log(err)
      });
  }


  async function getDelete() {
      alert('Usuário apagado com sucesso!');
      window.location.href = window.location.href.replace('/src/frontend/gerenciarperfil/index.html','/src/frontend/inicial/homepage.html')
  }


  async function editaLogin(event) {
      console.log("Função para processar o formulário do perfil...")

      event.preventDefault();

      var name = '';
      var username = document.getElementById('email').value;
      var phoneNumber = document.getElementById('phoneNumber').value;

      id = JSON.parse(localStorage.getItem("cache-login-user")).id;

      console.log("Obtem os dados de Nome, Email e Descrição a partir Dados Pessoais...")

      let perfil = {
          id: "",
          nome: "",
          email: "",
          celular: "",
      }

      perfil.id = id
      perfil.nome = name;
      perfil.email = username;
      perfil.celular = phoneNumber;

      console.log("Chamando a api para verificar perfil...")

      let baseURL = 'https://matchbookapi.herokuapp.com'

      // baseURL = 'http://localhost:5000'

      fetch(baseURL + "/api/v1/atualiza-usuario", {
          method: "PATCH",
          headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS, PATCH',
          'Access-Control-Request-Headers': 'access-control-allow-origin,content-type',
          'Access-Control-Request-Method': 'access-control-allow-origin,content-type'
          },
          body: JSON.stringify(perfil)
      }).then(res => {
          console.log("Esperando o callback da API... ")
      
          getResponse(res);
      }).catch(err => {
          console.log("A resposta da API quebrou...")
      
          console.log(err)
          user = {
              id: "",
              senha: "",
          };
      });
  }

  async function getResponse(res) {
          console.log("Esperando o callback da API... ")

          response = JSON.parse(await res.text());

          if (response.status === true) {
              alert('Usuário atualizado com sucesso!');
              localStorage.setItem('cache-login-user', JSON.stringify(response));
              window.location.href = window.location.href.replace('/src/frontend/gerenciarperfil/index.html?','/src/frontend/estante-lista/estantelivros.html')
          } else { // Se login falhou, avisa ao usuário
              alert('Erro na hora de atualizar!');
          }

      }


</script>
</html>
